datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// --------------------------------------
// Enums
// --------------------------------------

enum Gender {
  MALE
  FEMALE
}

enum Role {
  SUPER_ADMIN
  SCHOOL_ADMIN
  ACCOUNTANT // New Role
  ASSISTANT
  TEACHER
  STUDENT
}

enum Status {
  ACTIVE
  PENDING
  EXPIRED
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

enum ExpenseType {
  SALARY
  MAINTENANCE
  SUPPLIES
  OTHER
}

enum PaymentStatus {
  PENDING
  COMPLETED
  CANCELLED
  REFUNDED
}

enum PaymentType {
  TUITION
  TRANSPORT
  BOOKS
  UNIFORM
  ACTIVITIES
  OTHER
}

// --------------------------------------
// Core Models
// --------------------------------------

model User {
  id        String   @id @default(uuid())
  firstName String   @map("first_name")
  lastName  String   @map("last_name")
  email     String   @unique
  phone     String?
  password  String
  gender    Gender
  birthDate DateTime
  role      Role     @default(SCHOOL_ADMIN)

  // --- Relations ---

  // 1. School Membership
  schoolId String?
  school   School? @relation("SchoolMembers", fields: [schoolId], references: [id], onDelete: Cascade)

  // 2. School Ownership
  ownedSchool School? @relation("SchoolOwner")

  // 3. Academic (Student)
  classId String?
  class   Class?  @relation("ClassStudents", fields: [classId], references: [id])

  // 4. Academic (Teacher)
  subjects Subject[] @relation("TeacherSubjects")
  notes    Note[]    @relation("TeacherNotes")

  // 5. Financial (Student)
  paymentsMade Payment[] @relation("StudentPayments")

  // 6. Financial (Staff/Accountant)
  transactionsRecorded Payment[] @relation("PaymentRecorder")
  expensesRecorded     Expense[] @relation("ExpenseRecorder")
  salariesReceived     Expense[] @relation("ExpenseRecipient")

  // 7. Attendance
  attendanceRecords Attendance[] @relation("UserAttendance")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 8. Academic Results
  gradesAsStudent Grade[] @relation("StudentGrades")
  gradesAsTeacher Grade[] @relation("TeacherGrades")

  @@index([email])
  @@index([role])
  @@index([schoolId])
}

model School {
  id      String  @id @default(uuid())
  name    String  @unique
  slug    String  @unique
  logo    String?
  address String?
  phone   String?

  // Owner
  ownerId String @unique
  owner   User   @relation("SchoolOwner", fields: [ownerId], references: [id], onDelete: Cascade)

  // Members
  members User[] @relation("SchoolMembers")

  // Plan & Subscription
  subscription Subscription?

  // Academic Structure
  classes Class[]

  // Financial Records
  payments Payment[]
  expenses Expense[]

  // Attendance Records
  attendanceRecords Attendance[]

  // Academic Years
  academicYears AcademicYear[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --------------------------------------
// Subscription & Plans
// --------------------------------------

model Plan {
  id             String         @id @default(uuid())
  name           String         @unique
  description    String?
  price          Float          @default(0)
  maxStudents    Int            @default(50)
  maxTeachers    Int            @default(10)
  allowReports   Boolean        @default(false)
  storageLimit   Int            @default(100)
  durationInDays Int            @default(30)
  subscriptions  Subscription[]
  createdAt      DateTime       @default(now())
}

model Subscription {
  id        String   @id @default(uuid())
  schoolId  String   @unique
  school    School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  planId    String
  plan      Plan     @relation(fields: [planId], references: [id])
  startDate DateTime @default(now())
  endDate   DateTime
  status    Status   @default(PENDING)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --------------------------------------
// Academic Year Module
// --------------------------------------

model AcademicYear {
  id        String   @id @default(uuid())
  name      String // e.g. "2024-2025"
  startDate DateTime
  endDate   DateTime
  isCurrent Boolean  @default(false)

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  grades Grade[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, name])
  @@index([schoolId])
  @@index([isCurrent])
}

// --------------------------------------
// Academic Structure
// --------------------------------------

model Class {
  id   String @id @default(uuid())
  name String // e.g. "1st Grade"

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  students User[]    @relation("ClassStudents")
  subjects Subject[]
  notes    Note[]

  tuitionFee Float @default(0) // Fee for this class

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  attendances Attendance[]

  @@unique([schoolId, name])
  @@index([schoolId])
}

model Subject {
  id   String @id @default(uuid())
  name String // e.g. "Mathematics"

  classId String
  class   Class  @relation(fields: [classId], references: [id], onDelete: Cascade)

  teacherId String?
  teacher   User?   @relation("TeacherSubjects", fields: [teacherId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  grades    Grade[]

  @@index([classId])
  @@index([teacherId])
}

model Note {
  id      String @id @default(uuid())
  content String // The announcement

  classId String
  class   Class  @relation(fields: [classId], references: [id], onDelete: Cascade)

  teacherId String
  teacher   User   @relation("TeacherNotes", fields: [teacherId], references: [id])

  createdAt DateTime @default(now())
}

// --------------------------------------
// Financial Module
// --------------------------------------

model Payment {
  id            String        @id @default(uuid())
  amount        Float
  date          DateTime      @default(now())
  note          String? // e.g. "1st Installment"
  status        PaymentStatus @default(PENDING)
  paymentType   PaymentType   @default(TUITION)
  invoiceNumber String?       @unique

  studentId String
  student   User   @relation("StudentPayments", fields: [studentId], references: [id])

  schoolId String
  school   School @relation(fields: [schoolId], references: [id])

  recordedById String?
  recordedBy   User?   @relation("PaymentRecorder", fields: [recordedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
  @@index([studentId])
  @@index([status])
  @@index([date])
}

model Expense {
  id     String      @id @default(uuid())
  title  String // e.g. "Teacher Salary"
  amount Float
  type   ExpenseType
  date   DateTime    @default(now())

  schoolId String
  school   School @relation(fields: [schoolId], references: [id])

  recipientId String? // If salary
  recipient   User?   @relation("ExpenseRecipient", fields: [recipientId], references: [id])

  recordedById String?
  recordedBy   User?   @relation("ExpenseRecorder", fields: [recordedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
  @@index([type])
  @@index([date])
}

// --------------------------------------
// Attendance Module
// --------------------------------------

model Attendance {
  id     String           @id @default(uuid())
  date   DateTime         @default(now())
  status AttendanceStatus
  reason String?

  userId String
  user   User   @relation("UserAttendance", fields: [userId], references: [id], onDelete: Cascade)

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  // Optional linkage to Class for easier querying (if student)
  classId String?
  class   Class?  @relation(fields: [classId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, date, schoolId])
  @@index([schoolId])
  @@index([date])
}

// --------------------------------------
// Grades Module
// --------------------------------------

model Grade {
  id         String @id @default(uuid())
  score      Float // الدرجة التي حصل عليها الطالب
  totalScore Float  @default(100) // الدرجة الكاملة
  examType   String // مثلاً: "شهر أول"، "نصف سنة"، "نهائي"

  studentId String
  student   User   @relation("StudentGrades", fields: [studentId], references: [id])

  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id])

  teacherId String
  teacher   User   @relation("TeacherGrades", fields: [teacherId], references: [id])

  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studentId])
  @@index([subjectId])
  @@index([academicYearId])
}
